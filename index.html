<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>O5U4 â€” Dual Digit Bot</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c10;
    --surface: #0e1318;
    --border: #1a2330;
    --accent: #00e5ff;
    --green: #00ff88;
    --red: #ff3d5a;
    --gold: #ffd700;
    --text: #e8f0f7;
    --muted: #4a6070;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(0,229,255,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(0,255,136,0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 520px;
    margin: 0 auto;
    padding: 24px 16px;
    position: relative;
    z-index: 1;
  }

  /* HEADER */
  .header {
    text-align: center;
    margin-bottom: 32px;
    animation: fadeDown 0.6s ease;
  }

  .logo {
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent);
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .title {
    font-size: 42px;
    font-weight: 800;
    letter-spacing: -2px;
    background: linear-gradient(135deg, var(--accent), var(--green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1;
  }

  .subtitle {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
    font-family: 'JetBrains Mono', monospace;
  }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    animation: fadeUp 0.5s ease both;
  }

  .card-label {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  /* CONNECT SECTION */
  .connect-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  input[type="text"], input[type="password"] {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus { border-color: var(--accent); }

  .btn-connect {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-connect:hover { opacity: 0.85; transform: translateY(-1px); }
  .btn-connect:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* STATUS DOT */
  .status-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }

  .dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }
  .dot.error { background: var(--red); }

  .status-text {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
  }

  /* BALANCE */
  .balance-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .balance-amount {
    font-size: 32px;
    font-weight: 800;
    font-family: 'JetBrains Mono', monospace;
    color: var(--green);
    letter-spacing: -1px;
  }

  .balance-currency {
    font-size: 13px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
  }

  /* MARKET SELECT */
  select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a6070' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
  }

  select:focus { border-color: var(--accent); }
  select option { background: #0e1318; }

  /* STAKE */
  .stake-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 12px;
  }

  .stake-label {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    white-space: nowrap;
  }

  input[type="number"] {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 600;
    outline: none;
    transition: border-color 0.2s;
    text-align: center;
  }

  input[type="number"]:focus { border-color: var(--accent); }

  /* DIGIT FREQUENCY */
  .freq-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 4px;
    margin-top: 8px;
  }

  .freq-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .freq-digit {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
  }

  .freq-fill {
    width: 100%;
    border-radius: 4px;
    transition: height 0.4s ease, background 0.3s;
    min-height: 2px;
  }

  .freq-count {
    font-size: 9px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
  }

  /* LAST DIGIT */
  .last-digit-display {
    text-align: center;
    margin-bottom: 12px;
  }

  .last-digit-num {
    font-size: 64px;
    font-weight: 800;
    font-family: 'JetBrains Mono', monospace;
    line-height: 1;
    transition: color 0.3s;
  }

  .last-digit-price {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    margin-top: 4px;
  }

  /* TRADE BUTTON */
  .trade-btn {
    width: 100%;
    padding: 20px;
    border: none;
    border-radius: 16px;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    letter-spacing: 1px;
  }

  .trade-btn:not(:disabled) {
    background: linear-gradient(135deg, var(--accent), var(--green));
    color: var(--bg);
    box-shadow: 0 8px 32px rgba(0,229,255,0.25);
  }

  .trade-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,229,255,0.35);
  }

  .trade-btn:not(:disabled):active {
    transform: translateY(0);
  }

  .trade-btn:disabled {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: not-allowed;
  }

  .trade-btn-sub {
    font-size: 11px;
    font-weight: 400;
    font-family: 'JetBrains Mono', monospace;
    display: block;
    margin-top: 4px;
    opacity: 0.7;
  }

  /* DUAL INDICATOR */
  .dual-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }

  .side-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    text-align: center;
    transition: all 0.3s;
  }

  .side-card.win {
    border-color: var(--green);
    background: rgba(0,255,136,0.05);
    box-shadow: 0 0 20px rgba(0,255,136,0.1);
  }

  .side-card.lose {
    border-color: var(--red);
    background: rgba(255,61,90,0.05);
  }

  .side-card.pending {
    border-color: var(--accent);
    background: rgba(0,229,255,0.05);
    animation: glowPulse 1s infinite;
  }

  .side-label {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    letter-spacing: 2px;
    margin-bottom: 6px;
  }

  .side-value {
    font-size: 28px;
    font-weight: 800;
    font-family: 'JetBrains Mono', monospace;
  }

  .side-result {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    margin-top: 4px;
  }

  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }

  .stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    text-align: center;
  }

  .stat-val {
    font-size: 22px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
  }

  .stat-lbl {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--muted);
    margin-top: 4px;
    letter-spacing: 1px;
  }

  /* HISTORY */
  .history-list {
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    animation: fadeIn 0.3s ease;
  }

  .history-item:last-child { border-bottom: none; }

  .history-digit {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 13px;
  }

  .hist-win { color: var(--green); }
  .hist-loss { color: var(--red); }
  .hist-double-loss { color: var(--muted); }

  /* ANIMATIONS */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  @keyframes glowPulse {
    0%, 100% { box-shadow: 0 0 10px rgba(0,229,255,0.1); }
    50% { box-shadow: 0 0 20px rgba(0,229,255,0.3); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
  }

  .shake { animation: shake 0.3s ease; }

  .empty-history {
    text-align: center;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 20px;
  }

  /* ANIMATION DELAYS */
  .card:nth-child(1) { animation-delay: 0.1s; }
  .card:nth-child(2) { animation-delay: 0.2s; }
  .card:nth-child(3) { animation-delay: 0.3s; }
  .card:nth-child(4) { animation-delay: 0.4s; }
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="logo">Deriv Digit Bot</div>
    <div class="title">O5 Â· U4</div>
    <div class="subtitle">Over 5 & Under 4 â€” Dual Strike</div>
  </div>

  <!-- CONNECT -->
  <div class="card">
    <div class="card-label">API Connection</div>
    <div class="connect-row">
      <input type="password" id="apiToken" placeholder="Enter Deriv API token..." />
      <button class="btn-connect" id="btnConnect" onclick="connectWithToken()">Connect</button>
    </div>
    <div class="status-row">
      <div class="dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Not connected</span>
    </div>
  </div>

  <!-- BALANCE -->
  <div class="card" id="balanceCard" style="display:none">
    <div class="card-label">Account Balance</div>
    <div class="balance-display">
      <div>
        <div class="balance-amount" id="balanceAmount">0.00</div>
        <div class="balance-currency" id="balanceCurrency">USD</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted)">ACCOUNT</div>
        <div style="font-size:13px;font-family:'JetBrains Mono',monospace;color:var(--text)" id="accountId">â€”</div>
      </div>
    </div>
  </div>

  <!-- MARKET & STAKE -->
  <div class="card" id="tradeSetup" style="display:none">
    <div class="card-label">Trade Setup</div>
    <select id="market" onchange="if(connected){subscribeToMarket();fetchPayout();}">
      <optgroup label="Volatility Indices">
        <option value="R_10">Volatility 10 Index</option>
        <option value="R_25">Volatility 25 Index</option>
        <option value="R_50">Volatility 50 Index</option>
        <option value="R_75" selected>Volatility 75 Index</option>
        <option value="R_100">Volatility 100 Index</option>
        <option value="1HZ10V">Volatility 10 (1s)</option>
        <option value="1HZ25V">Volatility 25 (1s)</option>
        <option value="1HZ50V">Volatility 50 (1s)</option>
        <option value="1HZ75V">Volatility 75 (1s)</option>
        <option value="1HZ100V">Volatility 100 (1s)</option>
      </optgroup>
    </select>
    <div class="stake-row">
      <span class="stake-label">STAKE $</span>
      <input type="number" id="stake" value="5" min="1" step="0.5" oninput="fetchPayout()" />
    </div>

    <!-- PAYOUT PREVIEW -->
    <div id="payoutPreview" style="margin-top:14px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;display:none">
      <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted);letter-spacing:3px;margin-bottom:10px">PAYOUT PREVIEW</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="text-align:center;padding:8px;background:rgba(0,229,255,0.05);border-radius:8px">
          <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted)">O5 WINS â†’ RETURNS</div>
          <div id="payoutOver" style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent)">â€”</div>
        </div>
        <div style="text-align:center;padding:8px;background:rgba(255,215,0,0.05);border-radius:8px">
          <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted)">U4 WINS â†’ RETURNS</div>
          <div id="payoutUnder" style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--gold)">â€”</div>
        </div>
        <div style="text-align:center;padding:8px;background:rgba(0,255,136,0.05);border-radius:8px">
          <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted)">NET PROFIT (WIN - LOSS)</div>
          <div id="payoutNet" style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--green)">â€”</div>
          <div style="font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);margin-top:2px" id="payoutNetSub">winner return âˆ’ both stakes</div>
        </div>
        <div style="text-align:center;padding:8px;background:rgba(255,61,90,0.05);border-radius:8px">
          <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted)">IF 4 OR 5 HITS</div>
          <div id="payoutLoss" style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--red)">â€”</div>
          <div style="font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);margin-top:2px">both stakes lost</div>
        </div>
      </div>
      <div id="payoutLoading" style="text-align:center;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);display:none">Fetching rates...</div>
    </div>

    <!-- SIGNAL FILTER -->
    <div style="margin-top:14px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted);letter-spacing:3px">SIGNAL FILTER</div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <span style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted)" id="filterLabel">ON</span>
          <div style="position:relative;width:36px;height:20px" onclick="toggleFilter()">
            <input type="checkbox" id="filterToggle" checked style="display:none">
            <div id="filterTrack" style="position:absolute;inset:0;background:var(--green);border-radius:20px;transition:background 0.2s;box-shadow:0 0 8px rgba(0,255,136,0.4)"></div>
            <div id="filterThumb" style="position:absolute;top:3px;left:3px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform 0.2s;transform:translateX(16px)"></div>
          </div>
        </label>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap">Avoid 4 &amp; 5 in last</span>
        <input type="number" id="filterTicks" value="3" min="1" max="10" style="width:60px;text-align:center;font-size:14px;padding:6px 10px" />
        <span style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted)">ticks</span>
      </div>
      <div id="filterStatus" style="margin-top:10px;padding:8px;border-radius:8px;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);text-align:center;background:rgba(255,255,255,0.03)">
        Waiting for ticks...
      </div>
    </div>
  </div>


  <!-- DIGIT DISPLAY + FREQUENCY -->
  <div class="card" id="digitCard" style="display:none">
    <div class="card-label" id="digitCardLabel">Last Digit Â· Frequency Analysis</div>
    <div class="last-digit-display">
      <div class="last-digit-num" id="lastDigitNum">â€”</div>
      <div class="last-digit-price" id="lastDigitPrice">Waiting for ticks...</div>
    </div>
    <div class="freq-grid" id="freqGrid"></div>
  </div>

  <!-- DUAL SIDE CARDS -->
  <div class="dual-row" id="dualRow" style="display:none">
    <div class="side-card" id="overCard">
      <div class="side-label">OVER 5</div>
      <div class="side-value" style="color:var(--accent)">O5</div>
      <div id="overPrediction" style="font-size:10px;font-family:'JetBrains Mono',monospace;margin-top:4px;padding:3px 8px;border-radius:20px;display:inline-block">â€”</div>
      <div class="side-result" id="overResult">â€”</div>
    </div>
    <div class="side-card" id="underCard">
      <div class="side-label">UNDER 4</div>
      <div class="side-value" style="color:var(--gold)">U4</div>
      <div id="underPrediction" style="font-size:10px;font-family:'JetBrains Mono',monospace;margin-top:4px;padding:3px 8px;border-radius:20px;display:inline-block">â€”</div>
      <div class="side-result" id="underResult">â€”</div>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-row" id="statsRow" style="display:none">
    <div class="stat-box">
      <div class="stat-val" style="color:var(--green)" id="statWins">0</div>
      <div class="stat-lbl">WINS</div>
    </div>
    <div class="stat-box">
      <div class="stat-val" style="color:var(--red)" id="statLosses">0</div>
      <div class="stat-lbl">LOSSES</div>
    </div>
    <div class="stat-box">
      <div class="stat-val" id="statPnl">$0.00</div>
      <div class="stat-lbl">P&L</div>
    </div>
  </div>

  <!-- TRADE BUTTON -->
  <div id="tradeBtnWrap" style="display:none; margin-bottom:16px">
    <button class="trade-btn" id="tradeBtn" onclick="placeTrade()" disabled>
      PLACE TRADE
      <span class="trade-btn-sub" id="tradeBtnSub">Connect to start</span>
    </button>
  </div>

  <!-- HISTORY -->
  <div class="card" id="historyCard" style="display:none">
    <div class="card-label">Trade History</div>
    <div class="history-list" id="historyList">
      <div class="empty-history">No trades yet</div>
    </div>
  </div>

</div>

<script>
  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ws = null;
  let connected = false;
  let balance = 0;
  let currency = 'USD';
  let accountId = '';
  let lastDigit = null;
  let currentPrice = null;
  let digitCounts = new Array(10).fill(0);
  let totalTicks = 0;
  let trading = false;
  let pendingOver = false;
  let pendingUnder = false;
  let overResult = null;
  let underResult = null;
  let wins = 0;
  let losses = 0;
  let pnl = 0;
  let history = [];
  let currentMarket = 'R_75';
  let tickSubscription = null;
  let pendingProposals = {};
  let settledContracts = new Set();
  let tradeDigit = null;
  let heartbeatTimer = null;
  let reconnectTimer = null;
  let lastToken = '';

  // â”€â”€ APP CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const APP_ID = 1089;

  function connectWithToken() {
    const token = document.getElementById('apiToken').value.trim();
    if (!token) { setStatus('Enter API token', 'error'); return; }
    document.getElementById('btnConnect').disabled = true;
    connectAPI(token);
  }

  // â”€â”€ HEARTBEAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startHeartbeat() {
    stopHeartbeat();
    heartbeatTimer = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ ping: 1 }));
      }
    }, 30000);
  }

  function stopHeartbeat() {
    if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  }

  // â”€â”€ CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function connectAPI(token) {
    if (!token) return;

    if (ws) { ws.onclose = null; ws.onerror = null; ws.close(); ws = null; }
    stopHeartbeat();
    setStatus('Connecting...', '');

    ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=' + APP_ID);

    ws.onopen = () => {
      lastToken = token;
      setStatus('Authorizing...', '');
      ws.send(JSON.stringify({ authorize: token }));
      startHeartbeat();
    };

    ws.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        handleMessage(data);
      } catch (err) {
        console.error('Parse error:', err);
      }
    };

    ws.onerror = () => {
      setStatus('Connection error', 'error');
      connected = false;
    };

    ws.onclose = (e) => {
      connected = false;
      stopHeartbeat();
      if (lastToken && e.code !== 1000) {
        setStatus('Connection lost â€” reconnecting in 3s...', 'error');
        reconnectTimer = setTimeout(() => {
          if (!connected) connectAPI(lastToken);
        }, 3000);
      }
    };
  }

  // â”€â”€ INIT ON LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('load', () => {
    initFreqGrid();
  });

  // â”€â”€ MESSAGE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleMessage(data) {
    if (data.error) {
      const isAuthError = data.msg_type === 'authorize' || !connected;
      if (isAuthError) {
        setStatus('Auth error: ' + data.error.message, 'error');
        connected = false;
        lastToken = '';
        document.getElementById('btnConnect').disabled = false;
        if (ws) { ws.onclose = null; ws.close(); ws = null; }
      } else {
        console.warn('API error:', data.error.message);
        if (trading) {
          trading = false;
          pendingOver = false;
          pendingUnder = false;
          trading = false;
          pendingOver = false;
          pendingUnder = false;
          document.getElementById('tradeBtn').disabled = false;
          document.getElementById('tradeBtnSub').textContent = 'Over 5 + Under 4 simultaneously';
          setOverCard('', 'O5', 'Error');
          setUnderCard('', 'U4', 'Error');
          alert('Trade error: ' + data.error.message);
        }
      }
      return;
    }

    if (data.msg_type === 'authorize') {
      connected = true;
      balance = data.authorize.balance;
      currency = data.authorize.currency;
      accountId = data.authorize.loginid;

      setStatus('Connected Â· ' + accountId, 'connected');
      document.getElementById('btnConnect').disabled = false;
      document.getElementById('btnConnect').textContent = 'Reconnect';

      updateBalance(balance);

      // Show UI
      document.getElementById('balanceCard').style.display = 'block';
      document.getElementById('tradeSetup').style.display = 'block';
      document.getElementById('digitCard').style.display = 'block';
      document.getElementById('dualRow').style.display = 'grid';
      document.getElementById('statsRow').style.display = 'grid';
      document.getElementById('tradeBtnWrap').style.display = 'block';
      document.getElementById('historyCard').style.display = 'block';

      // Subscribe to ticks
      subscribeToMarket(); // also updates digitCardLabel
      setTimeout(fetchPayout, 500);
    }

    if (data.msg_type === 'tick') {
      const tick = data.tick;

      const price = tick.quote;
      // Hardcoded pip sizes per market (matches Deriv's display exactly)
      const PIP_SIZES = {
        'R_10': 3, 'R_25': 3, 'R_50': 4, 'R_75': 4, 'R_100': 2,
        '1HZ10V': 3, '1HZ25V': 3, '1HZ50V': 4, '1HZ75V': 4, '1HZ100V': 2
      };
      const pipSize = PIP_SIZES[currentMarket] || 4;
      const priceStr = price.toFixed(pipSize);
      const digit = parseInt(priceStr[priceStr.length - 1]);

      currentPrice = price;
      lastDigit = digit;
      totalTicks++;
      digitCounts[digit]++;

      updateDigitDisplay(digit, price);
      updateFreqGrid();

      // Track recent digits for signal filter
      recentDigits.push(digit);
      if (recentDigits.length > 20) recentDigits.shift();
      if (connected) updateFilterStatus();
    }

    if (data.msg_type === 'buy') {
      const contractId = data.buy.contract_id;
      const shortcode = data.buy.shortcode || '';
      const isOver = shortcode.startsWith('DIGITOVER');
      const isUnder = shortcode.startsWith('DIGITUNDER');

      if (isOver) {
        overContractId = contractId;
        setOverCard('pending', 'O5', 'Open #' + contractId);
      } else if (isUnder) {
        underContractId = contractId;
        setUnderCard('pending', 'U4', 'Open #' + contractId);
      }

      // Subscribe to settlement updates using shortcode-derived tag
      ws.send(JSON.stringify({
        proposal_open_contract: 1,
        contract_id: contractId,
        subscribe: 1,
        passthrough: { tag: isOver ? 'over' : 'under' }
      }));
    }

    if (data.msg_type === 'proposal_open_contract') {
      const contract = data.proposal_open_contract;
      const tag = data.passthrough && data.passthrough.tag;

      // Log key settlement fields
      console.log('[POC]', tag, 
        'status:', contract.status,
        'is_settled:', contract.is_settled,
        'is_expired:', contract.is_expired,
        'is_valid_to_sell:', contract.is_valid_to_sell,
        'profit:', contract.profit,
        'contract_id:', contract.contract_id
      );

      if (!trading) return;

      // Only settle when Deriv confirms final result:
      // - status explicitly 'won' or 'lost'
      // - OR contract expired AND can no longer be sold (truly done)
      const isDone = contract.status === 'won' ||
                     contract.status === 'lost' ||
                     (contract.is_expired === 1 && contract.is_valid_to_sell === 0);

      console.log('[POC isDone]', tag, isDone);
      if (!isDone) return;

      const profit = parseFloat(contract.profit);
      const contractId = contract.contract_id;

      // Prevent double-processing: skip if this side already settled
      const earlyTag = data.echo_req && data.echo_req.passthrough && data.echo_req.passthrough.tag;
      if (earlyTag === 'over' && !pendingOver) return;
      if (earlyTag === 'under' && !pendingUnder) return;
      if (!earlyTag && contractId === overContractId && !pendingOver) return;
      if (!earlyTag && contractId === underContractId && !pendingUnder) return;

      // Match using passthrough tag (most reliable), then contract ID, then contract_type
      const pocTag = data.echo_req && data.echo_req.passthrough && data.echo_req.passthrough.tag;
      let side = null;
      if (pocTag === 'over') {
        side = 'over';
      } else if (pocTag === 'under') {
        side = 'under';
      } else if (contractId && contractId === overContractId) {
        side = 'over';
      } else if (contractId && contractId === underContractId) {
        side = 'under';
      } else if (contract.contract_type === 'DIGITOVER') {
        side = 'over';
      } else if (contract.contract_type === 'DIGITUNDER') {
        side = 'under';
      }

      if (!side) return;

      if (side === 'over' && pendingOver) {
        overResult = profit;
        pendingOver = false;
        // Capture the actual settlement digit from exit tick
        if (contract.exit_tick_display_value) {
          const exitStr = contract.exit_tick_display_value.toString();
          tradeDigit = parseInt(exitStr[exitStr.length - 1]);
        }
        showSideResult('over', profit);
      } else if (side === 'under' && pendingUnder) {
        underResult = profit;
        pendingUnder = false;
        // Capture the actual settlement digit from exit tick
        if (contract.exit_tick_display_value) {
          const exitStr = contract.exit_tick_display_value.toString();
          tradeDigit = parseInt(exitStr[exitStr.length - 1]);
        }
        showSideResult('under', profit);
      }

      if (!pendingOver && !pendingUnder) {
        settleTrade();
      }
    }

    if (data.msg_type === 'balance') {
      updateBalance(data.balance.balance);
    }

    if (data.msg_type === 'proposal') {
      const reqId = data.req_id;
      if (reqId && pendingProposals[reqId]) {
        const payout = parseFloat(data.proposal.payout);
        pendingProposals[reqId](payout);
        delete pendingProposals[reqId];
      }
    }
  }

  // â”€â”€ SUBSCRIBE TO MARKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MARKET_NAMES = {
    'R_10': 'Volatility 10', 'R_25': 'Volatility 25', 'R_50': 'Volatility 50',
    'R_75': 'Volatility 75', 'R_100': 'Volatility 100',
    '1HZ10V': 'Volatility 10 (1s)', '1HZ25V': 'Volatility 25 (1s)',
    '1HZ50V': 'Volatility 50 (1s)', '1HZ75V': 'Volatility 75 (1s)',
    '1HZ100V': 'Volatility 100 (1s)'
  };

  function subscribeToMarket() {
    currentMarket = document.getElementById('market').value;

    // Update card label to show active market
    const marketName = MARKET_NAMES[currentMarket] || currentMarket;
    document.getElementById('digitCardLabel').textContent = 'Last Digit Â· ' + marketName;

    // Unsubscribe previous
    if (tickSubscription) {
      ws.send(JSON.stringify({ forget: tickSubscription }));
      tickSubscription = null;
    }

    // Reset digit counts, pip size and filter history
    digitCounts = new Array(10).fill(0);
    totalTicks = 0;
    recentDigits = [];
    initFreqGrid();

    ws.send(JSON.stringify({
      ticks: currentMarket,
      subscribe: 1
    }));

  }



  // â”€â”€ PAYOUT PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let payoutTimer = null;

  function fetchPayout() {
    if (!connected) return;
    clearTimeout(payoutTimer);
    payoutTimer = setTimeout(_doFetchPayout, 600);
  }

  function _doFetchPayout() {
    const stake = parseFloat(document.getElementById('stake').value);
    const market = document.getElementById('market').value;
    if (isNaN(stake) || stake < 0.35) return;

    document.getElementById('payoutPreview').style.display = 'block';
    document.getElementById('payoutLoading').style.display = 'block';
    document.getElementById('payoutOver').textContent = '...';
    document.getElementById('payoutUnder').textContent = '...';
    document.getElementById('payoutNet').textContent = '...';
    document.getElementById('payoutLoss').textContent = '...';

    let overPayout = null;
    let underPayout = null;

    // req_id must be a small integer for Deriv API
    const reqId1 = Math.floor(Math.random() * 900000) + 100000;
    const reqId2 = Math.floor(Math.random() * 900000) + 100000;

    function updatePayoutUI() {
      if (overPayout === null || underPayout === null) return;
      document.getElementById('payoutLoading').style.display = 'none';

      // You place stake on BOTH sides = total risk is stake*2
      // When one side wins: you get that payout back, but lose the other stake
      // Net profit = winning payout - stake (winner) - stake (loser) = payout - 2*stake
      const winnerPayout = Math.max(overPayout, underPayout); // they should be similar
      const netProfit = winnerPayout - (stake * 2);
      const fullLoss = stake * 2;

      document.getElementById('payoutOver').textContent = '$' + overPayout.toFixed(2);
      document.getElementById('payoutUnder').textContent = '$' + underPayout.toFixed(2);
      document.getElementById('payoutNet').textContent = (netProfit >= 0 ? '+' : '') + '$' + netProfit.toFixed(2);
      document.getElementById('payoutNet').style.color = netProfit >= 0 ? 'var(--green)' : 'var(--red)';
      document.getElementById('payoutLoss').textContent = '-$' + fullLoss.toFixed(2);
    }

    // Store pending proposal IDs so handleMessage can resolve them
    pendingProposals[reqId1] = function(payout) { overPayout = payout; updatePayoutUI(); };
    pendingProposals[reqId2] = function(payout) { underPayout = payout; updatePayoutUI(); };

    ws.send(JSON.stringify({
      proposal: 1,
      req_id: reqId1,
      amount: stake,
      basis: 'stake',
      contract_type: 'DIGITOVER',
      currency: currency,
      duration: 1,
      duration_unit: 't',
      symbol: market,
      barrier: '5'
    }));

    ws.send(JSON.stringify({
      proposal: 1,
      req_id: reqId2,
      amount: stake,
      basis: 'stake',
      contract_type: 'DIGITUNDER',
      currency: currency,
      duration: 1,
      duration_unit: 't',
      symbol: market,
      barrier: '4'
    }));
  }

  // â”€â”€ SIGNAL FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let recentDigits = [];
  let filterEnabled = true;

  function toggleFilter() {
    filterEnabled = !filterEnabled;
    const track = document.getElementById('filterTrack');
    const thumb = document.getElementById('filterThumb');
    const label = document.getElementById('filterLabel');
    if (filterEnabled) {
      track.style.background = 'var(--green)';
      track.style.boxShadow = '0 0 8px rgba(0,255,136,0.4)';
      thumb.style.transform = 'translateX(16px)';
      label.textContent = 'ON';
    } else {
      track.style.background = 'var(--muted)';
      track.style.boxShadow = 'none';
      thumb.style.transform = 'translateX(0)';
      label.textContent = 'OFF';
    }
    updateFilterStatus();
  }

  function updateFilterStatus() {
    if (!filterEnabled) {
      document.getElementById('filterStatus').textContent = 'Filter OFF â€” trading on every tick';
      document.getElementById('filterStatus').style.color = 'var(--muted)';
      return;
    }
    checkSignal();
  }

  function checkSignal() {
    const n = parseInt(document.getElementById('filterTicks').value) || 3;
    const recent = recentDigits.slice(-n);
    const hasDanger = recent.some(d => d === 4 || d === 5);
    const statusEl = document.getElementById('filterStatus');

    if (recent.length < n) {
      statusEl.textContent = 'Collecting ticks... (' + recent.length + '/' + n + ')';
      statusEl.style.color = 'var(--muted)';
      return false;
    }

    if (hasDanger) {
      const dangerTicks = recent.map((d,i) => d === 4 || d === 5 ? '#' + (recent.length - i) : null).filter(Boolean).join(', ');
      statusEl.textContent = 'BLOCKED â€” 4 or 5 seen in last ' + n + ' ticks (' + recent.join(',') + ')';
      statusEl.style.color = 'var(--red)';
      return false;
    } else {
      statusEl.textContent = 'CLEAR â€” last ' + n + ' ticks: ' + recent.join(', ');
      statusEl.style.color = 'var(--green)';
      return true;
    }
  }

  function isSignalClear() {
    if (!filterEnabled) return true;
    return checkSignal();
  }

  // â”€â”€ PLACE TRADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let overContractId = null;
  let underContractId = null;
  let tradeTimeout = null;

  function placeTrade() {
    if (!connected || trading) return;
    if (!isSignalClear()) {
      alert('Signal filter BLOCKED: digits 4 or 5 appeared in recent ticks. Wait for a clear signal.');
      return;
    }

    const stake = parseFloat(document.getElementById('stake').value);
    if (isNaN(stake) || stake < 1) {
      alert('Minimum stake is $1');
      return;
    }

    // Both sides require equal stake â€” block if balance can't cover both
    const totalRequired = stake * 2;
    if (balance < totalRequired) {
      alert('Insufficient balance. You need $' + totalRequired.toFixed(2) + ' to place both trades ($' + stake.toFixed(2) + ' each). Current balance: $' + balance.toFixed(2));
      return;
    }

    const market = document.getElementById('market').value;

    trading = true;
    pendingOver = true;
    pendingUnder = true;
    overResult = null;
    underResult = null;
    overContractId = null;
    underContractId = null;
    settledContracts = new Set();
    tradeDigit = lastDigit;

    // Safety timeout â€” reset if no result after 30 seconds
    tradeTimeout = setTimeout(() => {
      if (trading) {
        trading = false;
        pendingOver = false;
        pendingUnder = false;
        document.getElementById('tradeBtn').disabled = false;
        document.getElementById('tradeBtnSub').textContent = 'Over 5 + Under 4 simultaneously';
        setOverCard('', 'O5', 'â€”');
        setUnderCard('', 'U4', 'â€”');
        setStatus('Result timeout â€” check your Deriv account', 'error');
      }
    }, 30000);

    // Update UI
    document.getElementById('tradeBtn').disabled = true;
    document.getElementById('tradeBtnSub').textContent = 'Waiting for result...';

    setOverCard('pending', 'O5', 'Sending...');
    setUnderCard('pending', 'U4', 'Sending...');
    document.getElementById('overPrediction').textContent = '';
    document.getElementById('underPrediction').textContent = '';

    // Place OVER 5 â€” passthrough tag echoed back in buy response to identify contract
    ws.send(JSON.stringify({
      buy: 1,
      price: stake,
      parameters: {
        amount: stake,
        basis: 'stake',
        contract_type: 'DIGITOVER',
        currency: currency,
        duration: 1,
        duration_unit: 't',
        symbol: market,
        barrier: '5'
      },
      passthrough: { tag: 'over' }
    }));

    // Place UNDER 4 â€” passthrough tag echoed back in buy response to identify contract
    ws.send(JSON.stringify({
      buy: 1,
      price: stake,
      parameters: {
        amount: stake,
        basis: 'stake',
        contract_type: 'DIGITUNDER',
        currency: currency,
        duration: 1,
        duration_unit: 't',
        symbol: market,
        barrier: '4'
      },
      passthrough: { tag: 'under' }
    }));
  }

  // â”€â”€ SETTLE TRADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function settleTrade() {
    if (tradeTimeout) { clearTimeout(tradeTimeout); tradeTimeout = null; }
    const stake = parseFloat(document.getElementById('stake').value);
    const digit = tradeDigit !== null ? tradeDigit : lastDigit;

    // overResult and underResult are net profit per side from Deriv
    // e.g. win side: +X (profit only, stake already returned)
    //      loss side: -stake (full stake lost)
    // True net P&L = sum of both sides' profits
    const totalPnl = (overResult !== null ? overResult : 0) + (underResult !== null ? underResult : 0);

    pnl += totalPnl;

    // A win = one side had positive profit
    const oneWon = (overResult !== null && overResult > 0) || (underResult !== null && underResult > 0);
    let result;
    if (digit === 4 || digit === 5) {
      losses++;
      result = 'double-loss';
    } else if (oneWon) {
      wins++;
      result = 'win';
    } else {
      losses++;
      result = 'loss';
    }

    // Update stats
    updateStats();

    // Add to history â€” show true net P&L
    addHistory(digit, totalPnl, result);

    // Balance is updated accurately via the server's balance subscription message

    // Re-enable button
    trading = false;
    document.getElementById('tradeBtn').disabled = false;
    document.getElementById('tradeBtnSub').textContent = 'Over 5 + Under 4 simultaneously';
  }

  // â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(text, type) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    dot.className = 'dot' + (type ? ' ' + type : '');
    txt.textContent = text;
    txt.style.color = type === 'connected' ? 'var(--green)' : type === 'error' ? 'var(--red)' : 'var(--muted)';
  }

  function updateBalance(bal) {
    document.getElementById('balanceAmount').textContent = parseFloat(bal).toFixed(2);
    document.getElementById('balanceCurrency').textContent = currency;
    document.getElementById('accountId').textContent = accountId;
  }

  function updateDigitDisplay(digit, price) {
    const el = document.getElementById('lastDigitNum');
    el.textContent = digit;

    // Color by zone (explicit check for 0 since it's falsy)
    if (digit >= 0 && digit <= 3) el.style.color = 'var(--gold)';
    else if (digit >= 6) el.style.color = 'var(--accent)';
    else el.style.color = 'var(--red)';

    document.getElementById('lastDigitPrice').textContent = price.toFixed(2);

    // Highlight the active digit bar in the freq grid
    for (let i = 0; i <= 9; i++) {
      const bar = document.getElementById('freq-fill-' + i);
      if (bar) bar.style.outline = (i === digit) ? '2px solid white' : 'none';
    }

    // Live prediction badges â€” show which side would win RIGHT NOW
    if (!trading) {
      const overWins  = digit > 5;
      const underWins = digit < 4;
      const overEl  = document.getElementById('overPrediction');
      const underEl = document.getElementById('underPrediction');

      if (overWins) {
        overEl.textContent  = 'âœ“ WOULD WIN';
        overEl.style.background = 'rgba(0,255,136,0.15)';
        overEl.style.color  = 'var(--green)';
      } else if (digit === 5) {
        overEl.textContent  = 'âœ— DANGER';
        overEl.style.background = 'rgba(255,61,90,0.15)';
        overEl.style.color  = 'var(--red)';
      } else {
        overEl.textContent  = 'âœ— WOULD LOSE';
        overEl.style.background = 'rgba(255,61,90,0.10)';
        overEl.style.color  = 'var(--red)';
      }

      if (underWins) {
        underEl.textContent  = 'âœ“ WOULD WIN';
        underEl.style.background = 'rgba(0,255,136,0.15)';
        underEl.style.color  = 'var(--green)';
      } else if (digit === 4) {
        underEl.textContent  = 'âœ— DANGER';
        underEl.style.background = 'rgba(255,61,90,0.15)';
        underEl.style.color  = 'var(--red)';
      } else {
        underEl.textContent  = 'âœ— WOULD LOSE';
        underEl.style.background = 'rgba(255,61,90,0.10)';
        underEl.style.color  = 'var(--red)';
      }
    }

    // Enable trade button
    if (connected && !trading) {
      document.getElementById('tradeBtn').disabled = false;
      document.getElementById('tradeBtnSub').textContent = 'Over 5 + Under 4 simultaneously';
    }
  }

  function initFreqGrid() {
    const grid = document.getElementById('freqGrid');
    grid.innerHTML = '';
    for (let i = 0; i <= 9; i++) {
      const bar = document.createElement('div');
      bar.className = 'freq-bar';
      bar.innerHTML = `
        <div class="freq-digit">${i}</div>
        <div class="freq-fill" id="freq-fill-${i}" style="height:2px;background:var(--border)"></div>
        <div class="freq-count" id="freq-count-${i}">0</div>
      `;
      grid.appendChild(bar);
    }
  }

  function updateFreqGrid() {
    const max = Math.max(...digitCounts, 1);
    for (let i = 0; i <= 9; i++) {
      const pct = digitCounts[i] / max;
      const height = Math.max(2, pct * 40);
      const fill = document.getElementById('freq-fill-' + i);
      const count = document.getElementById('freq-count-' + i);
      if (!fill) continue;

      fill.style.height = height + 'px';
      fill.style.background = i <= 3 ? 'var(--gold)' : i >= 6 ? 'var(--accent)' : 'var(--red)';
      count.textContent = digitCounts[i];
    }
  }

  function setOverCard(state, value, result) {
    const card = document.getElementById('overCard');
    const val = document.getElementById('overCard').querySelector('.side-value');
    const res = document.getElementById('overResult');
    card.className = 'side-card ' + state;
    val.textContent = value;
    res.textContent = result;
    res.style.color = state === 'win' ? 'var(--green)' : state === 'lose' ? 'var(--red)' : 'var(--accent)';
  }

  function setUnderCard(state, value, result) {
    const card = document.getElementById('underCard');
    const val = document.getElementById('underCard').querySelector('.side-value');
    const res = document.getElementById('underResult');
    card.className = 'side-card ' + state;
    val.textContent = value;
    res.textContent = result;
    res.style.color = state === 'win' ? 'var(--green)' : state === 'lose' ? 'var(--red)' : 'var(--accent)';
  }

  function showSideResult(side, profit) {
    const isWin = profit > 0;
    if (side === 'over') {
      setOverCard(isWin ? 'win' : 'lose', 'O5', (isWin ? '+' : '') + profit.toFixed(2));
    } else {
      setUnderCard(isWin ? 'win' : 'lose', 'U4', (isWin ? '+' : '') + profit.toFixed(2));
    }
  }

  function updateStats() {
    document.getElementById('statWins').textContent = wins;
    document.getElementById('statLosses').textContent = losses;
    const pnlEl = document.getElementById('statPnl');
    pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
    pnlEl.style.color = pnl >= 0 ? 'var(--green)' : 'var(--red)';
  }

  function addHistory(digit, totalPnl, result) {
    const list = document.getElementById('historyList');

    // Remove empty state
    const empty = list.querySelector('.empty-history');
    if (empty) empty.remove();

    const item = document.createElement('div');
    item.className = 'history-item';

    const digitColor = digit <= 3 ? '#ffd700' : digit >= 6 ? '#00e5ff' : '#ff3d5a';
    const pnlColor = totalPnl > 0 ? 'var(--green)' : 'var(--red)';
    const pnlText = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
    const resultText = result === 'double-loss' ? 'ðŸ’¥ Both lost' : totalPnl > 0 ? 'âœ“ Win' : 'âœ— Loss';

    item.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <div class="history-digit" style="background:${digitColor}22;color:${digitColor}">${digit}</div>
        <span style="color:var(--muted);font-size:11px">${resultText}</span>
      </div>
      <span style="color:${pnlColor};font-weight:600">${pnlText}</span>
    `;

    list.insertBefore(item, list.firstChild);

    // Keep last 20
    while (list.children.length > 20) list.removeChild(list.lastChild);
  }


</script>
</body>
</html>
